# ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚±ãƒƒãƒˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ‡ãƒ¢

Redisã‚’ä½¿ç”¨ã—ã¦å¤–éƒ¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚±ãƒƒãƒˆã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã™ã‚‹Spring Bootã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚
**Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆ**ã¨**Bucket4j**ã®ä¸¡æ–¹ã®å®Ÿè£…ã‚’æä¾›ã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨æ©Ÿèƒ½æ€§ã‚’æ¯”è¼ƒã§ãã¾ã™ã€‚

## ğŸš€ æ©Ÿèƒ½

- **2ã¤ã®å®Ÿè£…æ–¹å¼**:
  - **Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆ**: è»½é‡ã§é«˜é€Ÿã€Redisç‰¹åŒ–
  - **Bucket4j**: æˆç†Ÿã—ãŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€è±Šå¯Œãªæ©Ÿèƒ½
- **ãƒˆãƒ¼ã‚¯ãƒ³ãƒã‚±ãƒƒãƒˆã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: å›ºå®šãƒ¬ãƒ¼ãƒˆã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è£œå……ã™ã‚‹ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ–¹å¼
- **Redisçµ±åˆ**: åˆ†æ•£ç’°å¢ƒã§ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™çŠ¶æ…‹ã®å…±æœ‰
- **AOPãƒ™ãƒ¼ã‚¹**: ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ç°¡å˜ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’é©ç”¨
- **æŸ”è»Ÿãªè¨­å®š**: ãƒã‚±ãƒƒãƒˆã”ã¨ã«ç•°ãªã‚‹åˆ¶é™ã‚’è¨­å®šå¯èƒ½
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ†é›¢**: ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã«ãƒã‚±ãƒƒãƒˆã‚’åˆ†é›¢
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ**: ä¸¡å®Ÿè£…ã®å®Ÿè¡Œæ™‚é–“ã¨æ©Ÿèƒ½æ€§ã‚’æ¯”è¼ƒ

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Controller    â”‚â”€â”€â”€â–¶â”‚  RateLimit      â”‚â”€â”€â”€â–¶â”‚  TokenBucket    â”‚
â”‚                 â”‚    â”‚  Aspect         â”‚    â”‚  Service        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                       â”‚
                                â–¼                       â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Annotation    â”‚    â”‚      Redis      â”‚
                       â”‚   @RateLimit    â”‚    â”‚                 â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Controller    â”‚â”€â”€â”€â–¶â”‚  Bucket4j       â”‚â”€â”€â”€â–¶â”‚  ProxyManager   â”‚
â”‚   (Bucket4j)    â”‚    â”‚  Service        â”‚    â”‚  (Redis/Local)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š å®Ÿè£…æ¯”è¼ƒ

| é …ç›® | Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆ | Bucket4j |
|------|----------------|-----------|
| **é–‹ç™ºé€Ÿåº¦** | é«˜é€Ÿ | ä¸­ç¨‹åº¦ |
| **å®Ÿè¡Œæ€§èƒ½** | æœ€é«˜ | é«˜ |
| **ä¿å®ˆæ€§** | ä¸­ç¨‹åº¦ | æœ€é«˜ |
| **æ©Ÿèƒ½æ€§** | ä¸­ç¨‹åº¦ | æœ€é«˜ |
| **å­¦ç¿’ã‚³ã‚¹ãƒˆ** | ä¸­ç¨‹åº¦ | ä½ |
| **åˆ†æ•£å¯¾å¿œ** | åŸºæœ¬ | å……å®Ÿ |
| **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰** | Redisç‰¹åŒ– | å¤šæ§˜ |

## âš™ï¸ è¨­å®š

### application.yml

```yaml
spring:
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms

token-bucket:
  capacity: 10          # ãƒã‚±ãƒƒãƒˆã®å®¹é‡
  refill-rate: 1        # ãƒªãƒ•ã‚£ãƒ«ãƒ¬ãƒ¼ãƒˆ
  refill-time: 1        # ãƒªãƒ•ã‚£ãƒ«æ™‚é–“
  refill-time-unit: SECONDS  # ãƒªãƒ•ã‚£ãƒ«æ™‚é–“ã®å˜ä½
```

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

## ğŸ³ Dockerã§ã®å®Ÿè¡Œ

### å‰ææ¡ä»¶
- Docker
- Docker Compose
- Makeï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

### ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

```bash
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆRedisã€ãƒ¢ãƒƒã‚¯APIã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
make up

# ã¾ãŸã¯ã€Docker Composeã‚’ç›´æ¥ä½¿ç”¨
docker-compose up -d
```

### åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
make help

# Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰
make build

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿èµ·å‹•
make up-app

# å…¨ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
make up

# å…¨ã‚µãƒ¼ãƒ“ã‚¹åœæ­¢
make down

# ãƒ­ã‚°è¡¨ç¤º
make logs

# ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
make status

# ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
make health

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
make clean
```

### ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹

- **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: http://localhost:8080
- **Redis Commander**: http://localhost:8081 (admin/admin123)
- **RedisInsight**: http://localhost:8001
- **è»½é‡API**: http://localhost:8082
- **HTTPBin**: http://localhost:8086

### é–‹ç™ºãƒ¢ãƒ¼ãƒ‰

```bash
# ãƒ­ã‚°ä»˜ãã§èµ·å‹•ï¼ˆé–‹ç™ºç”¨ï¼‰
make dev
```

## ğŸ¯ ä½¿ç”¨æ–¹æ³•

### 1. Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ

```java
@RateLimit(bucketKey = "api_endpoint", tokens = 1)
public String callApi() {
    return "API response";
}
```

### 2. Bucket4jç‰ˆ

```java
// è‡ªå‹•çš„ã«ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒé©ç”¨ã•ã‚Œã‚‹
public String callApi() {
    if (!rateLimitService.tryConsumeRedis("api_endpoint", 1)) {
        throw new RuntimeException("Rate limit exceeded");
    }
    return "API response";
}
```

## ğŸŒ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ

- `GET /api/light` - è»½é‡APIï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/medium` - ä¸­ç¨‹åº¦APIï¼ˆ3ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/heavy` - é‡é‡APIï¼ˆ5ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/user/{userId}` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰APIï¼ˆ2ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/async` - éåŒæœŸAPIï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰

### Bucket4jç‰ˆ

- `GET /api/bucket4j/light` - è»½é‡APIï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/bucket4j/medium` - ä¸­ç¨‹åº¦APIï¼ˆ3ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/bucket4j/heavy` - é‡é‡APIï¼ˆ5ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/bucket4j/user/{userId}` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰APIï¼ˆ2ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/bucket4j/async` - éåŒæœŸAPIï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰
- `GET /api/bucket4j/local` - ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç‰ˆï¼ˆ1ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»ï¼‰

### æ¯”è¼ƒãƒ»ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

- `GET /comparison/light` - è»½é‡APIã®æ¯”è¼ƒ
- `GET /comparison/medium` - ä¸­ç¨‹åº¦APIã®æ¯”è¼ƒ
- `GET /comparison/heavy` - é‡é‡APIã®æ¯”è¼ƒ
- `GET /comparison/user/{userId}` - ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰APIã®æ¯”è¼ƒ
- `GET /comparison/async` - éåŒæœŸAPIã®æ¯”è¼ƒ
- `GET /comparison/benchmark` - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯

### ãƒã‚±ãƒƒãƒˆç®¡ç†

- `GET /api/bucket/{bucketKey}/status` - ãƒã‚±ãƒƒãƒˆã®çŠ¶æ…‹ç¢ºèª
- `POST /api/bucket/{bucketKey}/reset` - ãƒã‚±ãƒƒãƒˆã®ãƒªã‚»ãƒƒãƒˆ
- `GET /api/health` - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### å‰ææ¡ä»¶

- Java 21
- Redis 6.0+
- Gradle 8.0+

### 1. Redisã®èµ·å‹•

```bash
# Dockerã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
docker run -d -p 6379:6379 redis:7-alpine

# ã¾ãŸã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§Redisã‚’èµ·å‹•
redis-server
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•

```bash
./gradlew bootRun
```

### 3. ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸
chmod +x test_rate_limit.sh
chmod +x test_comparison.sh

# Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆã®ãƒ†ã‚¹ãƒˆ
./test_rate_limit.sh

# ä¸¡æ–¹ã®å®Ÿè£…ã®æ¯”è¼ƒãƒ†ã‚¹ãƒˆ
./test_comparison.sh
```

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### å€‹åˆ¥ãƒ†ã‚¹ãƒˆ

```bash
# Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆ
curl http://localhost:8080/api/light

# Bucket4jç‰ˆ
curl http://localhost:8080/api/bucket4j/light
```

### æ¯”è¼ƒãƒ†ã‚¹ãƒˆ

```bash
# è»½é‡APIã®æ¯”è¼ƒ
curl http://localhost:8080/comparison/light

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
curl http://localhost:8080/comparison/benchmark
```

## ğŸ”§ ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆç‰ˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```java
@RateLimit(bucketKey = "custom_api", tokens = 3, 
           errorMessage = "Custom rate limit exceeded")
public String customApi() {
    return "Custom API response";
}
```

### Bucket4jç‰ˆã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```java
@Bean
public BucketConfiguration customBucketConfiguration() {
    return BucketConfiguration.builder()
        .addLimit(Bandwidth.classic(20, Refill.intervally(5, Duration.ofSeconds(1))))
        .build();
}
```

## ğŸ“Š ç›£è¦–ã¨ãƒ­ã‚°

- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®é©ç”¨çŠ¶æ³ã¯ãƒ­ã‚°ã«è¨˜éŒ²
- ãƒã‚±ãƒƒãƒˆã®çŠ¶æ…‹ã¯APIã§ç¢ºèªå¯èƒ½
- Redisã§ãƒˆãƒ¼ã‚¯ãƒ³æ¶ˆè²»å±¥æ­´ã‚’è¿½è·¡
- ä¸¡å®Ÿè£…ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¯”è¼ƒ

## ğŸ¯ ä½¿ã„åˆ†ã‘ã®æŒ‡é‡

### Luaã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’é¸ã¶ã¹ãå ´åˆ

- **ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®ã¿å¿…è¦**
- **Redisã®ã¿ã‚’ä½¿ç”¨**
- **è»½é‡ãªå®Ÿè£…ã‚’é‡è¦–**
- **ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã®è‡ªç”±åº¦ã‚’é‡è¦–**
- **å­¦ç¿’ç›®çš„ã‚„ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—**

### Bucket4jã‚’é¸ã¶ã¹ãå ´åˆ

- **æœ¬æ ¼çš„ãªãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ç’°å¢ƒ**
- **è¤‡æ•°ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã®åˆ†æ•£é‹ç”¨**
- **è±Šå¯Œãªç›£è¦–ãƒ»è¨ºæ–­æ©Ÿèƒ½ãŒå¿…è¦**
- **ãƒãƒ¼ãƒ é–‹ç™ºã§ã®ä¿å®ˆæ€§é‡è¦–**
- **Spring Bootã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã§ã®çµ±åˆ**

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

1. **Redisæ¥ç¶šã‚¨ãƒ©ãƒ¼**: Redisã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
2. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãŒåŠ¹ã‹ãªã„**: AOPãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
3. **Bucket4jã®ä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼**: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®äº’æ›æ€§ã‚’ç¢ºèª

### ãƒ­ã‚°ã®ç¢ºèª

```bash
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°ã®ç¢ºèª
tail -f logs/application.log

# Redisãƒ­ã‚°ã®ç¢ºèª
tail -f /var/log/redis/redis-server.log
```

## ğŸ“š å‚è€ƒè³‡æ–™

- [Bucket4jå…¬å¼ãƒªãƒã‚¸ãƒˆãƒª](https://github.com/bucket4j/bucket4j)
- [Bucket4jå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://bucket4j.github.io/)
- [Spring Boot Redisçµ±åˆ](https://spring.io/projects/spring-data-redis)

## ï¿½ï¿½ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License 